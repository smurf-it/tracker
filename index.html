<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tip Tracker for Delivery Drivers</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <header>
        <h1>Tip Tracker for Delivery Drivers</h1>
    </header>

    <section class="shift">
        <h2>Start Your Shift</h2>
        <div class="button-container">
            <button id="startShiftButton">Start Shift</button>
            <button id="endShiftButton" style="display: none;">End Shift</button>
        </div>
        <div id="shiftInfo" class="shift-info" style="display: none;">
            <p id="shiftStartTime"></p>
            <p id="totalShiftTime"></p>
        </div>
    </section>

    <section id="tipEntrySection" style="display: none;">
        <section class="tip-entry">
            <h2>Log a New Tip</h2>
            <form id="tipForm">
                <div class="payment-options">
                    <div id="cashOption" class="payment-option" data-type="cash">
                        <i class="fas fa-euro-sign"></i>
                        <span>Cash</span>
                    </div>
                    <div id="cardOption" class="payment-option" data-type="card">
                        <i class="fas fa-credit-card"></i>
                        <span>Card</span>
                    </div>                    
                </div>
                <input type="number" step="0.01" placeholder="Tip Amount" id="tipAmount" required disabled title="Please select a payment option first!">
                <button type="submit" disabled>Add Tip</button>
            </form>
        </section>
    </section>

    <section class="history">
        <h2>Tip History</h2>
        <div class="history-summary">
            Total Tips: <span id="totalTipsAmount">$0.00</span>
            <button id="clearHistoryButton">Clear History</button>
        </div>
        <div class="payment_preview">
            <div id="cashTotal" class="payment-total" data-type="cash">
                <i class="fas fa-euro-sign"></i>
                <span id="totalCashTipsAmount">€0.00</span>
            </div>
            <div id="cardOption" class="payment-total" data-type="card">
                <i class="fas fa-credit-card"></i>
                <span id="totalCardTipsAmount">€0.00</span>
            </div> 
        </div>
        <table id="tipHistory">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Time</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Entries will be populated here -->
            </tbody>
        </table>
    </section>

    <!-- GRAPH -->
    <section class="graph">
        <h2>Tips Over Time</h2>
        <canvas id="tipsChart" width="400" height="200"></canvas>
    </section>

    <!-- HIDDEN MODALS -->
    <div id="durationModal" class="modal">
        <div class="modal-content">
            <p id="durationMessage"></p>
            <p id="durationTips"></p>
            <button id="okButton">OK</button>
        </div>
    </div>    

    <div id="clearHistoryModal" class="modal">
        <div class="modal-content">
            <p>Are you sure you want to clear the tip history?</p>
            <div class="button-container">
                <button id="confirmClearButton" class="confirm">Yes</button>
                <button id="cancelClearButton" class="cancel">No</button>
            </div>
        </div>
    </div>

    <div id="editTipModal" class="modal">
        <div class="modal-content">
            <h2>Edit Tip</h2>
            <form id="editTipForm">
                <input type="number" id="editTipAmount" step="0.01" placeholder="Enter the new tip value" required>
                <button type="submit">Update</button>
                <button type="button" id="cancelEditButton">Cancel</button>
            </form>
        </div>
    </div>
    
</div>

<script>
// Initialize variables
let shiftStartTime = null;
let tips = [];
let selectedPaymentType = null; // Variable to store selected payment type
let orderIdCounter = 1; // Initialize order ID counter


let tipsChart;
let chartData = {
    labels: [],
    datasets: [{
        label: 'Tips ($)',
        data: [],
        borderColor: 'rgba(155, 89, 182, 1)',
        backgroundColor: 'rgba(155, 89, 182, 0.2)',
        fill: true,
    }]
};

function createChart() {
    const ctx = document.getElementById('tipsChart').getContext('2d');
    tipsChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            plugins: {
                legend: {
                    onClick: (e) => e.stopPropagation()
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Tips ($)'
                    }
                }
            }
        }
    });
}

function updateChart(dateTime, amount) {
    const date = new Date(dateTime);
    const options = { hour: '2-digit', minute: '2-digit', hour12: false };
    const label = date.toLocaleTimeString('en-GB', options);
    chartData.labels.push(label);
    chartData.datasets[0].data.push(amount);
    tipsChart.update();
}

window.onload = function() {
    createChart();
    const savedTips = getCookie("tips");
    if (savedTips) {
        tips = JSON.parse(savedTips);
        tips.forEach((tip, index) => {
            addTipToHistory(tip.orderId, tip.dateTime, tip.amount, false, index, tip.paymentType);
            updateChart(tip.dateTime, tip.amount);
        });
        updateTotalTipsDisplay(); 
    }

    // Check for active shift
    const savedShiftStartTime = getCookie("shiftStartTime");
    const isShiftActive = getCookie("isShiftActive") === "true";
    if (savedShiftStartTime && isShiftActive) {
        shiftStartTime = new Date(savedShiftStartTime);
        document.getElementById('shiftStartTime').textContent = `Started at: ${shiftStartTime.toLocaleString()}`;
        document.getElementById('shiftInfo').style.display = 'block';
        document.getElementById('startShiftButton').style.display = 'none';
        document.getElementById('endShiftButton').style.display = 'inline';
        document.getElementById('tipEntrySection').style.display = 'block'; 
    }

    // Reset payment method
    selectedPaymentType = null; // Clear selected payment type
    toggleTipInput(false); // Disable input and button
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('selected'); // Deselect all payment options
    });

    // Clear the tip amount input
    document.getElementById('tipAmount').value = '';
    
    // Ensure the tip input is initially disabled
    toggleTipInput(false);
};

// Modify the addTipToHistory function
function addTipToHistory(orderId, dateTime, amount, addToTotal = true, index = tips.length, paymentType = null) {
    const tableBody = document.querySelector('#tipHistory tbody');
    const newRow = document.createElement('tr');

    const formattedDateTime = formatDateTime(dateTime);
    const paymentIcon = paymentType === 'cash' ? '<i class="fas fa-euro-sign"></i>' : '<i class="fas fa-credit-card"></i>';
    
    // Combine tip amount with payment icon
    newRow.innerHTML = `
        <td>${orderId}</td>
        <td>${formattedDateTime}</td>
        <td>${paymentIcon} €<span class="tip-amount">${amount.toFixed(2)}</span></td>
        <td>
            <button class="editTipButton" data-index="${index}">Edit</button>
        </td>`;

    tableBody.appendChild(newRow);

    if (addToTotal) {
        tips.push({ orderId, dateTime, amount, paymentType });
        setCookie("tips", JSON.stringify(tips), 7);
        updateTotalTipsDisplay();
        updateChart(dateTime, amount);
    }

    newRow.querySelector('.editTipButton').addEventListener('click', function() {
        const tipIndex = index;
        document.getElementById('editTipAmount').value = '';
        document.getElementById('editTipForm').dataset.index = tipIndex;
        document.getElementById('editTipModal').style.display = 'block';
    });
}

function formatShiftDate(dateTime) {
    const date = new Date(dateTime);
    const day = String(date.getDay()).padStart(2, '0');
    const month = String(date.getMonth()).padStart(2, '0');
    const year = String(date.getFullYear());

    return `${day}/${month}/${year}`;

}

function formatDateTime(dateTime) {
    const date = new Date(dateTime);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${hours}:${minutes}`; // Return time only
}


function updateTotalTipsDisplay() {
    const totalTips = tips.reduce((total, tip) => total + tip.amount, 0);
    const totalCash = tips.filter(tip => tip.paymentType === 'cash').reduce((total, tip) => total + tip.amount, 0);
    const totalCard = tips.filter(tip => tip.paymentType === 'card').reduce((total, tip) => total + tip.amount, 0);

    document.getElementById('totalTipsAmount').textContent = `€${totalTips.toFixed(2)}`;
    document.getElementById('totalCashTipsAmount').textContent = `€${totalCash.toFixed(2)}`;
    document.getElementById('totalCardTipsAmount').textContent = `€${totalCard.toFixed(2)}`;
}


document.getElementById('tipForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const tipAmount = parseFloat(document.getElementById('tipAmount').value);
    const currentTime = new Date().toISOString();
    const orderId = orderIdCounter; // Incrementing order ID
    addTipToHistory(orderId, currentTime, tipAmount, true, tips.length, selectedPaymentType);
    orderIdCounter++; // Increment the order ID for the next tip
    event.target.reset(); 
    updateTotalTipsDisplay(); 
    selectedPaymentType = null; // Reset the payment type
    document.querySelector('.payment-option.selected')?.classList.remove('selected');
    toggleTipInput(false);
});





function toggleTipInput(enable) {
    document.getElementById('tipAmount').disabled = !enable;
    document.querySelector('button[type="submit"]').disabled = !enable;
}

// Modify the payment option click event
document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', function() {
        selectedPaymentType = this.getAttribute('data-type');
        document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        setCookie("selectedPaymentType", selectedPaymentType, 7); // Save the selected payment type
        toggleTipInput(true);
    });
});




// document.getElementById('editTipForm').addEventListener('submit', function(event) {
//     event.preventDefault();
//     const index = parseInt(this.dataset.index); 
//     const newAmount = parseFloat(document.getElementById('editTipAmount').value);
//     tips[index] = { dateTime: tips[index].dateTime, amount: newAmount };
//     setCookie("tips", JSON.stringify(tips), 7);
//     const tableBody = document.querySelector('#tipHistory tbody');
//     const rows = tableBody.querySelectorAll('tr');
//     rows[index].querySelector('.tip-amount').textContent = newAmount.toFixed(2);
//     chartData.datasets[0].data[index] = newAmount; 
//     tipsChart.update();
//     updateTotalTipsDisplay();
//     document.getElementById('editTipModal').style.display = 'none';
// });

document.getElementById('editTipForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const index = parseInt(this.dataset.index);
    const newAmount = parseFloat(document.getElementById('editTipAmount').value);
    
    // Get the original payment type to preserve it
    const paymentType = tips[index].paymentType;

    // Update the amount in the tips array
    tips[index] = { ...tips[index], amount: newAmount }; // Keep other properties

    setCookie("tips", JSON.stringify(tips), 7);

    const tableBody = document.querySelector('#tipHistory tbody');
    const rows = tableBody.querySelectorAll('tr');
    rows[index].querySelector('.tip-amount').textContent = newAmount.toFixed(2);
    
    // Update chart data
    chartData.datasets[0].data[index] = newAmount;
    tipsChart.update();

    // Update total amounts after editing
    updateTotalTipsDisplay();

    document.getElementById('editTipModal').style.display = 'none';
});


document.getElementById('cancelEditButton').addEventListener('click', function() {
    document.getElementById('editTipModal').style.display = 'none'; 
});

document.getElementById('clearHistoryButton').addEventListener('click', function() {
    document.getElementById('clearHistoryModal').style.display = 'block';
});

document.getElementById('confirmClearButton').addEventListener('click', function() {
    tips = [];
    orderIdCounter = 1; // Reset the order ID counter
    setCookie("tips", JSON.stringify(tips), 7); // Clear tips from cookies
    setCookie("orderIdCounter", orderIdCounter, 7); // Reset order ID counter in cookies
    document.querySelector('#tipHistory tbody').innerHTML = ''; 
    updateTotalTipsDisplay(); 
    resetChart(); 
    document.getElementById('clearHistoryModal').style.display = 'none'; 
});

document.getElementById('cancelClearButton').addEventListener('click', function() {
    document.getElementById('clearHistoryModal').style.display = 'none'; 
});

function resetChart() {
    chartData.labels = [];
    chartData.datasets[0].data = [];
    tipsChart.update(); 
}

document.getElementById('startShiftButton').addEventListener('click', function() {
    shiftStartTime = new Date();
    document.getElementById('shiftStartTime').textContent = `Started at: ${shiftStartTime.toLocaleString()}`;
    document.getElementById('shiftInfo').style.display = 'block';
    this.style.display = 'none';
    document.getElementById('endShiftButton').style.display = 'inline';
    document.getElementById('tipEntrySection').style.display = 'block'; 

    // Save shift start time and active status
    setCookie("shiftStartTime", shiftStartTime.toISOString(), 7);
    setCookie("isShiftActive", "true", 7);
});

document.getElementById('endShiftButton').addEventListener('click', function() {
    const shiftEndTime = new Date();
    const duration = calculateShiftDuration(shiftStartTime, shiftEndTime);
    const totalTipsInShift = tips.reduce((total, tip) => total + tip.amount, 0);
    const totalCashInShift = tips.filter(tip => tip.paymentType === 'cash').reduce((total, tip) => total + tip.amount, 0);
    const totalCardInShift = tips.filter(tip => tip.paymentType === 'card').reduce((total, tip) => total + tip.amount, 0);

    document.getElementById('durationMessage').textContent = `You worked for: ${duration}`;
    document.getElementById('durationTips').innerHTML = `
        <i class="fas fa-euro-sign"></i> Tips: $${totalCashInShift.toFixed(2)}
        <i class="fas fa-credit-card"></i> Tips: $${totalCardInShift.toFixed(2)}<br><br>
        Total Tips in Shift: $${totalTipsInShift.toFixed(2)}`;
    
    document.getElementById('durationModal').style.display = 'block';
    shiftStartTime = null; 
    document.getElementById('shiftInfo').style.display = 'none';
    this.style.display = 'none';
    document.getElementById('startShiftButton').style.display = 'inline';
    document.getElementById('tipEntrySection').style.display = 'none'; 
    setCookie("shiftStartTime", "", -1); 
});


document.getElementById('okButton').addEventListener('click', function() {
    document.getElementById('durationModal').style.display = 'none';
});

function calculateShiftDuration(start, end) {
    const duration = new Date(end - start);
    const hours = duration.getUTCHours();
    const minutes = duration.getUTCMinutes();
    return `${hours} hours and ${minutes} minutes`;
}

function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
}

function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
}

function toggleTipInput(enable) {
    const tipAmountInput = document.getElementById('tipAmount');

    tipAmountInput.disabled = !enable;
    document.querySelector('button[type="submit"]').disabled = !enable;

    if (enable) {
        tipAmountInput.title = ""; // Clear the title when enabling input
    } else {
        tipAmountInput.title = "Please select a payment option first!"; // Set the tooltip when disabling input
    }
}

// Set the initial placeholder when the page loads
document.getElementById('tipAmount').placeholder = "Tip Amount";

document.querySelectorAll('.payment-option').forEach(option => {
    option.addEventListener('click', function() {
        selectedPaymentType = this.getAttribute('data-type');
        document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        toggleTipInput(true); // Enable the tip input when an option is selected

        // Restore the placeholder
        document.getElementById('tipAmount').placeholder = "Tip Amount";
    });
});

// Modify the toggleTipInput function
function toggleTipInput(enable) {
    const tipAmountInput = document.getElementById('tipAmount');

    tipAmountInput.disabled = !enable;
    document.querySelector('button[type="submit"]').disabled = !enable;

    if (!enable) {
        tipAmountInput.placeholder = "Please select a payment method first"; // Set the placeholder when disabling input
        tipAmountInput.title = "Please select a payment option first!"; // Set the tooltip when disabling input
    } else {
        tipAmountInput.title = ""; // Clear the title when enabling input
    }
}

// Optionally, call toggleTipInput with false when the page first loads
toggleTipInput(false);


</script>

</body>
</html>
